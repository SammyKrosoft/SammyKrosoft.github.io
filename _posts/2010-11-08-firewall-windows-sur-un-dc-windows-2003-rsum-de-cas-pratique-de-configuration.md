---
layout: post
title: FireWall Windows sur un DC Windows 2003 – résumé de cas pratique de configuration
date: 2010-11-08 11:24
author: sammykrosoft
comments: true
categories: [Uncategorized]
---
<p>&#160;</p>  <p><strong>I – Configuration de ports statiques pour la réplication AD et le service de réplication de fichiers </strong></p>  <ul>   <li>Sélectionner 2 ports <strong>entre 49152 et 65535</strong> (dans notre exemple nous prendrons <strong>60000</strong> et <strong>60001</strong> – en Hexa:EA60 et EA61) </li>    <li>Sur tous vos DCs de votre forêt, ajoutez les clés de registre suivantes :      <ul>       <li><strong>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters</strong>           <ul>           <li>Nom de valeur :<strong> RPC TCP/IP Port Assignment</strong> </li>            <li>Type de valeur: <strong>REG_DWORD</strong> </li>            <li>Donnée de valeur : <strong>60000 (en Hexa : EA60)</strong> </li>         </ul>       </li>        <li><strong>KEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTFRS\Parameters</strong>           <ul>           <li>Nom de valeur: <strong>TCP/IP Port</strong> </li>            <li>Type de valeur: <strong>REG_DWORD</strong> </li>            <li>Donnée de valeur: <strong>60001 (en Hexa : EA61)</strong> </li>         </ul>       </li>     </ul>   </li> </ul>  <p><strong></strong></p>  <p><strong>II – Configuration des pare-feux pour vos contrôleurs de domaine via GPO</strong></p>  <ul>   <li>2 possibilités, au choix :      <ul>       <li>sur la stratégie “<strong>Default Domain Controller</strong>” </li>        <li>dans une nouvelle stratégie que vous lierez qu conteneur “<strong>Domain Controllers</strong>” </li>     </ul>   </li> </ul>  <p>Pour changer ou créer une nouvelle stratégie, le moyen le plus pratique est d’utiliser la console GPO “GPMC” (pour Group Policy Management Console) disponible à l’adresse suivante : <a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=0a6d4c24-8cbd-4b35-9272-dd3cbfc81887&amp;DisplayLang=en">http://www.microsoft.com/downloads/details.aspx?FamilyID=0a6d4c24-8cbd-4b35-9272-dd3cbfc81887&amp;DisplayLang=en</a></p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/7674.image_2.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-73-61-metablogapi/7674.image_5F00_2.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/6840.image_thumb.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-73-61-metablogapi/6840.image_5F00_thumb.png" width="502" height="353" /></a></p>  <p>Fig.- Console GPMC</p>  <ul>   <li>Avant de commencer : </li> </ul>  <p>Sachez que deux configurations du pare-feu Windows sont utilisées par les machines Windows :</p>  <ul>   <ul>     <li>profil “<strong>Domain</strong>” – utilisé lorsqu’un ordinateur est joint à un domaine </li>      <li>profil “<strong>Standard</strong>” – utilisé lorsqu’un ordinateur n’est pas joint à un domaine. </li>   </ul> </ul>  <p><strong>Spécificité des DCs</strong> : Un DC Windows 2003 utilisera le profil “<strong>Domain</strong>” après sa promotion, puis le profil “<strong>Standard</strong>” après sa première réplication et un redémarrage ultérieur <em>(référence : </em><a title="http://support.microsoft.com/kb/555381/en-us" href="http://support.microsoft.com/kb/555381/en-us"><em>http://support.microsoft.com/kb/555381/en-us</em></a><em>)</em></p>  <p>&#160;</p>  <p>Pour configurer les paramètres du pare-feu de vos contrôleurs de domaines, utilisez donc les MEMES réglages pour les profils “<strong>Domain</strong>” et “<strong>Standard</strong>” qui se trouvent au niveau du conteneur suivant dans l’éditeur de stratégies GPO :</p>  <p>&#160;</p>  <p><strong>Computer Configuration\</strong> </p>  <blockquote>   <p><strong>Administrative Templates\</strong> </p>    <p><strong>Network\</strong> </p>    <p><strong>Network Connections\</strong> </p>    <p><strong>Windows Firewall\</strong> </p>    <p><strong>Domain Profile </strong>OR<strong> Standard Profile</strong></p> </blockquote>  <p><em>(référence : </em><a title="http://technet.microsoft.com/en-us/library/cc785865(WS.10).aspx" href="http://technet.microsoft.com/en-us/library/cc785865(WS.10).aspx"><em>http://technet.microsoft.com/en-us/library/cc785865(WS.10).aspx</em></a><em>)</em></p>  <p>&#160;</p>  <p><strong>Illustrations:</strong></p>  <p>&#160;</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/0741.image_4.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-73-61-metablogapi/0741.image_5F00_4.png"><img style="background-image: none; border-right-width: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/0741.image_thumb_1.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-73-61-metablogapi/0741.image_5F00_thumb_5F00_1.png" width="232" height="244" /></a></p>  <p>Fig.- Console GPMC – un clic droit sur la stratégie “Default Domain Controllers Policy” ouvrira la fenêtre d’édition de la stratégie (Group Policy Object Editor)</p>  <p>&#160;</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/4073.image_8.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-73-61-metablogapi/4073.image_5F00_8.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/8508.image_thumb_3.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-73-61-metablogapi/8508.image_5F00_thumb_5F00_3.png" width="577" height="381" /></a></p>  <p>Fig.- Fenêtre d’édition de GPO – focus sur les profils du pare-feux Windows (Domain et Standard)</p>  <p>&#160;</p>  <p><strong>III – Configuration des stratégies pour le pare-feux Windows “Domain” et “Standard”</strong></p>  <p>a. Windows Firewall: Protect all network connections – Enabled</p>  <p>b. Windows Firewall: Allow remote administration exception – Enabled</p>  <blockquote>   <p>ce point active les ports 135 (RPC) et 445 (SMB)</p> </blockquote>  <p>b. Windows Firewall: Allow file and printer sharing exception: – Enabled</p>  <p>c. Windows Firewall: Define port exceptions: – Enabled </p>  <p>liste des ports à renseigner dans la liste d’exception de ports (rentrer chaque ligne telle quelle):</p>  <blockquote>   <p>123:udp:*:enabled:NTP      <br />3268:tcp:*:enabled:Global Catalog LDAP       <br />389:tcp:*:enabled:LDAP       <br />389:udp:*:enabled:LDAP       <br />53:tcp:*:enabled:DNS       <br />53:udp:*:enabled:DNS       <br />60000:tcp:*:enabled:AD Replication (Note: port choisi au préalable c.f. paragraphe II-)       <br />60001:tcp:*:enabled:File Replication Service (Note: port choisi au préalable c.f. paragraphe II-)       <br />88:tcp:*:enabled:Kerberos       <br />88:udp:*:enabled:Kerberos</p> </blockquote>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/2248.image_10.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-73-61-metablogapi/2248.image_5F00_10.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/7028.image_thumb_4.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/CommunityServer-Blogs-Components-WeblogFiles/00-00-00-73-61-metablogapi/7028.image_5F00_thumb_5F00_4.png" width="394" height="201" /></a></p>  <p>Fig.- Liste des ports telle qu’elle doit apparaître dans la liste d’exception de ports</p>  <p>&#160;</p>  <p><strong>IV – Références </strong></p>  <h3><font size="2">How to configure Windows Server 2003 SP1 firewall for a Domain Controller      <br /></font><a title="http://support.microsoft.com/kb/555381/en-us" href="http://support.microsoft.com/kb/555381/en-us"><font size="2">http://support.microsoft.com/kb/555381/en-us</font></a></h3>  <p><font size="2"><strong>Help: Administering Windows Firewall with Group Policy        <br /></strong></font><a title="http://technet.microsoft.com/en-us/library/cc785865(WS.10).aspx" href="http://technet.microsoft.com/en-us/library/cc785865(WS.10).aspx">http://technet.microsoft.com/en-us/library/cc785865(WS.10).aspx</a></p>  <p><strong>Active Directory Replication over Firewalls      <br /></strong><a title="http://technet.microsoft.com/en-us/library/bb727063.aspx" href="http://technet.microsoft.com/en-us/library/bb727063.aspx">http://technet.microsoft.com/en-us/library/bb727063.aspx</a></p>  <h3><font size="2">Restricting Active Directory replication traffic and client RPC traffic to a specific port      <br /></font><a title="http://support.microsoft.com/kb/224196/en-us" href="http://support.microsoft.com/kb/224196/en-us"><font size="2">http://support.microsoft.com/kb/224196/en-us</font></a></h3>
