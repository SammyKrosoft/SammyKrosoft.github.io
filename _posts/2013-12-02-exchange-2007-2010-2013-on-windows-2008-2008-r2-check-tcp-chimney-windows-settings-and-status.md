---
layout: post
title: Exchange 2007, 2010, 2013 on Windows 2008 / 2008 R2 â€“ Check TCP Chimney Windows settings and status
date: 2013-12-02 10:29
author: sammykrosoft
comments: true
categories: [Uncategorized]
---
<p>Hey,<p></p><p>If you ever encounter some messages that takes time to be delivered from HUB servers to Mailbox servers (we call this step "Mapi Submission" or "MAPI Delivery") or even from HUB to another HUB in a remote site, and your network don't have bandwidth or latency or general reliability or other configuration issues such as wrong MTU, wrong speed set on equipments, then check for the Windows TCP Chimney and RSS settings.</p><p>These are part of what we call the "Network Scalability Pack" (<a href="http://technet.microsoft.com/en-us/network/bb545631.aspx">http://technet.microsoft.com/en-us/network/bb545631.aspx</a>) and their primary use is to offload the CPU from processing network packets, offloading it down to the network card. It's supposed to remove network processing load from the CPU and give the work to the network card instead.</p><p>In the past, when installed on Windows 2003 servers, we had issues with this setting being used with Exchange (see this : <a href="http://support.microsoft.com/kb/948496">http://support.microsoft.com/kb/948496</a>), and we recommended to deactivate these TCP chimney, RSS and sometimes network DMA features as well. But experience showed that we can encounter sporadic issues as well on Windows 2008/Exchange 2007 and 2010 (especially&nbsp;for HUB submission queues) under certain circumstances due to these settings; these circumstances can be the network card driver TCP offload features not very compatible with how Exchange uses the network, or simply the network card driver being too old to handle the TCP offloading features... hard to tell exactly why anyways until we do a full raw debugging, which I didn't do.</p><p></p><p>Anyways, when we encountered network issues on Windows 2008/Exchange 2007/2010 and we also troubleshooted the issue thoroughly to ensure that were not related to bandwidth , latency , general reliability , other configuration issues such as wrong MTU, wrong speed set on equipments,bad network driver, etc..., disabling TCP chimney and RSS magically solved our issues; AND, no reboot is theorically necessary after changing these using netsh (but as we always say, when in doubt, reboot).</p><p></p><ul>
<li><span style="font-size:medium;"><strong><span style="text-decoration:underline;">To check for the current TCP Chimney, RSS and NetDMA settings do :</span></strong></span></li>
</ul><p><span style="font-family:courier new,courier;"><strong><span style="font-size:large;">Netsh int tcp show global</span></strong></span></p><p></p><p>For Windows 2008 R2 it will give you the following output-ish:</p><p><span style="font-family:Courier New;">PS C:UsersAdministrator.CONTOSO&gt; netsh int tcp show global <br>Querying active state... </span></p><p><span style="font-family:Courier New;">TCP Global Parameters <br> ---------------------------------------------- <br>Receive-Side Scaling State&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : enabled <br>Chimney Offload State&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : automatic <br>NetDMA State&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : enabled <br> Direct Cache Acess (DCA)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : disabled <br>Receive Window Auto-Tuning Level&nbsp;&nbsp;&nbsp; : normal <br>Add-On Congestion Control Provider&nbsp; : ctcp <br> ECN Capability&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : disabled <br> RFC 1323 Timestamps&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : disabled</span></p><p></p><p></p><ul>
<li><span style="font-family:arial,helvetica,sans-serif;font-size:medium;"><strong><span style="text-decoration:underline;">To print out network cards that actually have the TCP Chimney functionnality activated :</span></strong></span></li>
</ul><p><span style="font-family:courier new,courier;font-size:large;"><strong>Netsh int tcp show chimneystats</strong></span></p><p></p><p>On the below example, you see Under the &ldquo;Supp&rdquo; column the value &ldquo;No&rdquo;, meaning that TCP Chimney is not supported or not enabled on the Network card driver settings, otherwise you&rsquo;d see &ldquo;Yes&rdquo; with some values on &ldquo;TMax&rdquo; and &ldquo;PMax&rdquo;.</p><p><span style="font-family:Courier new;">PS C:UsersAdministrator.CONTOSO&gt; netsh int tcp show chimneystats </span></p><p><span style="font-family:Courier new;">Idx&nbsp; Supp&nbsp; Atmpt&nbsp;&nbsp;&nbsp; TMax&nbsp;&nbsp;&nbsp; PMax&nbsp;&nbsp;&nbsp;&nbsp; Olc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Failure Reason <br> ---&nbsp; ----&nbsp; -----&nbsp;&nbsp;&nbsp; ----&nbsp;&nbsp;&nbsp; ----&nbsp;&nbsp;&nbsp;&nbsp; ---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -------------- <br>&nbsp; 11&nbsp;&nbsp;&nbsp; No&nbsp; -n/a-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -n/a- </span></p><p><span style="font-family:Courier new;">&nbsp; Idx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - Interface (NIC) index used by the system <br>&nbsp; Supp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - Interface (NIC) supports TCP chimney offload <br>&nbsp; Atmpt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - System has attempted TCP connection offload <br>&nbsp; TMax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - Offload capacity advertized by the NIC <br>&nbsp; PMax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - Offload capacity observed by the system <br>&nbsp; Olc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - Number of currently offloaded connections <br>&nbsp; FailureReason - Reason why last attempt to offload a connection failed </span></p><p><span style="font-family:Courier New;"> Use `<span style="font-size:medium;"><strong>netsh int tcp show chimneystats &lt;Idx&gt;</strong></span>' for more details.</span></p><p></p><p></p><ul>
<li><span style="font-size:medium;text-decoration:underline;"><strong><span style="font-family:arial,helvetica,sans-serif;">To disable TCP Chimney and RSS:</span></strong></span></li>
</ul><p><span style="font-family:courier new,courier;font-size:medium;"><strong>netsh int tcp set global chimney=disabled</strong></span></p><p><strong><span style="font-family:courier new,courier;font-size:medium;">netsh int tcp set global rss=disabled</span></strong></p><p></p><p>For details and reference about the above commands, see <a href="http://support.microsoft.com/kb/951037">http://support.microsoft.com/kb/951037</a></p></p>

