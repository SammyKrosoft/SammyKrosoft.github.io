---
layout: post
title: Notes from the field–Bulk create 2000 mailboxes and their associated AD accounts from a CSV file + generating 2000 messages in the queues of an Exchange 2007 server in a Lab (to be continued)
date: 2012-10-25 13:08
author: sammykrosoft
comments: true
categories: [Uncategorized]
---
<p>&#160;</p>  <p>&#160;</p>  <p>- The prerequisite step is to create a “Test” OU</p>  <p>- Then the first step is to create a CSV file using Excel containing 2000 test user names and a minimum set of attributes for these users (<em>Display Name, sAMAccountName, UserPrincipalName, First Name, Last Name</em>). Easy with the “fill series function” of Excel</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/5466.image_2.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/5466.image_5F00_2.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/0027.image_thumb.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/0027.image_5F00_thumb.png" width="528" height="332" /></a></p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/6862.image_4.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/6862.image_5F00_4.png"><img style="background-image: none; border-right-width: 0px; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/1007.image_thumb_1.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/1007.image_5F00_thumb_5F00_1.png" width="244" height="142" /></a></p>  <p>&#160;</p>  <p>Then save the file as a CSV file using Excel.</p>  <p>- The second step is to import that CSV file as 2000 mailboxes using the following script from <strong>David Hall</strong> from his <a href="http://www.signalwarrant.com/2012/09/15/create-multiple-mailboxes-with-csv-input-powershell/">Signal Warrant blog</a> (giving back to Caesar what is Caesar’s <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/1323.wlEmoticon-smile_2.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/1323.wlEmoticon_2D00_smile_5F00_2.png" /> thank you very much David for this simple script !– Just comment my article if you want me to remove your script from my blog page). I modified it very slightly, you can refer to David’s blog for the original one, or create one on your own from scratch using this <a href="http://technet.microsoft.com/en-us/library/bb310752(v=exchg.80).aspx">Technet article - Using the Exchange Management Shell for Bulk Recipient Management</a>. </p>  <p>Here is a paste from the slightly modified Dave’s script, I left the comments anyways as they are very useful to make it work: </p>  <p>&#160;</p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&lt;#</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-tab-count: 1">&#160;&#160;&#160;&#160;&#160; </span>** THIS SCRIPT IS PROVIDED WITHOUT WARRANTY, USE AT YOUR OWN RISK **<span style="mso-tab-count: 1">&#160; </span></font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><span style="mso-spacerun: yes"><font face="Courier New"><font color="#008000" size="1">&#160;&#160;&#160; </font></font></span></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>.SYNOPSIS</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-tab-count: 1">&#160;&#160;&#160;&#160;&#160; </span><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>Create new mailboxes in Exchange 2010 and the corresponding user in Active Directory.</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&#160;</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-tab-count: 1">&#160;&#160;&#160;&#160;&#160; </span>.DESCRIPTION</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-tab-count: 1">&#160;&#160;&#160;&#160;&#160; </span><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>Use the New-Mailbox cmdlet to create mailboxes. The script will prompt you for the default password for all users. </font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>All accounts are set to prompt the user to change the password at first logon. It then prompts for what OU you want to put the users in, </font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>change the OU variable AD paths and variable names to correspond to your AD structure.<span style="mso-spacerun: yes">&#160; </span></font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>Once the users are created a log file is written to the $logPath.</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&#160;</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>.REQUIREMENTS</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>1.<span style="mso-tab-count: 1">&#160; </span>If you run this script from somewhere other than Exchange server you will need Exchange Management tools installed.</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>2.<span style="mso-tab-count: 1">&#160; </span>The mailbox.csv file filled out.</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>3.<span style="mso-tab-count: 1">&#160; </span>The proper Exchange RBAC role (Exchange 2010) or permission (Exchange 2007) to create mailboxes.</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>4.<span style="mso-spacerun: yes">&#160; </span>The CSV file will need the following columns; Display Name, sAMAccountName, UserPrincipalName, First Name, Last Name</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>5.<span style="mso-spacerun: yes">&#160; </span>set-executionpolicy remotesigned</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>6.<span style="mso-spacerun: yes">&#160; </span>Customize the $csvPath, $userDB, $logPath and the OU names and variables to match your infrastructure.</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&#160;</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160; </span>.NOTES</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-spacerun: yes">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>Tested with Exchange 2010, Windows 7, Windows Vista, Windows Server 2003, Windows Server 2K8 and 2K8 R2</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&#160;</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-tab-count: 1">&#160;&#160;&#160;&#160;&#160; </span>.AUTHOR</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-tab-count: 2">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span>David Hall | http://www.signalwarrant.com/</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><span style="mso-tab-count: 2"><font face="Courier New"><font color="#008000" size="1">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font></span></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000"><font size="1"><span style="mso-tab-count: 1">&#160;&#160;&#160;&#160;&#160; </span>.LINK</font></font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><span style="mso-tab-count: 2"><font face="Courier New"><font color="#008000" size="1">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font></span></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">#&gt;</font></font></span><span style="font-family: ; color: "></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1"># If not called, install the Exchange PSSnapin – Exchange 2007 only – use the “Import-Module” commandlet appropriately for Exchange 2010</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><b><span style="font-family: ; color: "><font color="#5f9ea0">Add-PSSnapin</font></span></b><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">Microsoft.Exchange.Management.PowerShell.Admin</font></span><span style="font-family: ; color: "> </span><i><span style="font-family: ; color: "><font color="#5f9ea0">-ErrorAction</font></span></i><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">SilentlyContinue</font></span></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1"># Supply the password for all the newly created accounts</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: "><font color="#800080">$password</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> </span><b><span style="font-family: ; color: "><font color="#5f9ea0">read-host</font></span></b><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot;Enter Default Password for all accounts created&quot;</font></span><span style="font-family: ; color: "> </span><i><span style="font-family: ; color: "><font color="#5f9ea0">-AsSecureString</font></span></i></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: "><font color="#800080">$ou</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot;&quot;</font></span></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1"># Define these as you wish</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1"># You'll need a provisionned Mailbox.csv file, and a test database</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: "><font color="#800080">$csvPath</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot;C:\TEMP\mailboxes.csv&quot;</font></span></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: "><font color="#800080">$userDB</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot;TestDB&quot;</font></span></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: "><font color="#800080">$logPath</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot;c:\TEMP\log.txt&quot;</font></span></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1"># you can change the OU and associated variable names to fit your needs</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ; mso-ansi-language: fr" lang="FR"><font color="#800080">$ou</font></span><span style="font-family: ; color: ; mso-ansi-language: fr" lang="FR"> </span><span style="font-family: ; color: ; mso-ansi-language: fr" lang="FR"><font color="#ff0000">=</font></span><span style="font-family: ; color: ; mso-ansi-language: fr" lang="FR"> </span><span style="font-family: ; color: ; mso-ansi-language: fr" lang="FR"><font color="#800000">&quot;DOMAINA.CONTOSO.CA/TestUnit&quot;</font></span></font><span style="font-family: ; color: ; mso-ansi-language: fr" lang="FR"></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: ; mso-ansi-language: fr" lang="FR"><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: ; mso-ansi-language: fr" lang="FR"><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font face="Courier New"><font size="1"><b><span style="font-family: ; color: "><font color="#5f9ea0">Import-CSV</font></span></b><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot;$csvPath&quot;</font></span><span style="font-family: ; color: "> | </span><b><span style="font-family: ; color: "><font color="#5f9ea0">ForEach</font></span></b><span style="font-family: ; color: "> {</span></font></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">New-Mailbox </span><b><span style="font-family: ; color: "><font color="#5f9ea0">`</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">-Password </span><span style="font-family: ; color: "><font color="#800080">$password</font></span><span style="font-family: ; color: "> </span><b><span style="font-family: ; color: "><font color="#5f9ea0">`</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">-Name </span><span style="font-family: ; color: "><font color="#800080">$_</font></span><span style="font-family: ; color: ">.</span><span style="font-family: ; color: "><font color="#800000">'Display Name'</font></span><span style="font-family: ; color: "> </span><b><span style="font-family: ; color: "><font color="#5f9ea0">`</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">-Alias </span><span style="font-family: ; color: "><font color="#800080">$_</font></span><span style="font-family: ; color: ">.</span><span style="font-family: ; color: "><font color="#800000">'sAMAccountName'</font></span><span style="font-family: ; color: "> </span><b><span style="font-family: ; color: "><font color="#5f9ea0">`</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">-OrganizationalUnit </span><span style="font-family: ; color: "><font color="#800080">$ou</font></span><span style="font-family: ; color: "> </span><b><span style="font-family: ; color: "><font color="#5f9ea0">`</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">-sAMAccountName </span><span style="font-family: ; color: "><font color="#800080">$_</font></span><span style="font-family: ; color: ">.</span><span style="font-family: ; color: "><font color="#800000">'sAMAccountName'</font></span><span style="font-family: ; color: "> </span><b><span style="font-family: ; color: "><font color="#5f9ea0">`</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">-FirstName </span><span style="font-family: ; color: "><font color="#800080">$_</font></span><span style="font-family: ; color: ">.</span><span style="font-family: ; color: "><font color="#800000">'First Name'</font></span><b><span style="font-family: ; color: "><font color="#5f9ea0">`</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">-LastName </span><span style="font-family: ; color: "><font color="#800080">$_</font></span><span style="font-family: ; color: ">.</span><span style="font-family: ; color: "><font color="#800000">'Last Name'</font></span><b><span style="font-family: ; color: "><font color="#5f9ea0">`</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">-DisplayName </span><span style="font-family: ; color: "><font color="#800080">$_</font></span><span style="font-family: ; color: ">.</span><span style="font-family: ; color: "><font color="#800000">'Display Name'</font></span><span style="font-family: ; color: "> </span><b><span style="font-family: ; color: "><font color="#5f9ea0">`</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">-UserPrincipalName </span><span style="font-family: ; color: "><font color="#800080">$_</font></span><span style="font-family: ; color: ">.</span><span style="font-family: ; color: "><font color="#800000">'UserPrincipalName'</font></span><span style="font-family: ; color: "> </span><b><span style="font-family: ; color: "><font color="#5f9ea0">`</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">-Database </span><span style="font-family: ; color: "><font color="#800080">$userDB</font></span><span style="font-family: ; color: "> </span><b><span style="font-family: ; color: "><font color="#5f9ea0">`</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">-ResetPasswordOnNextLogon </span><span style="font-family: ; color: "><font color="#800080">$true</font></span></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: ">} | </span><b><span style="font-family: ; color: "><font color="#5f9ea0">out-file</font></span></b><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800080">$logPath</font></span><span style="font-family: ; color: "> </span><i><span style="font-family: ; color: "><font color="#5f9ea0">-append</font></span></i></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><b><span style="font-family: ; color: "><font color="#5f9ea0">Write-Host</font></span></b><span style="font-family: ; color: "> </span><i><span style="font-family: ; color: "><font color="#5f9ea0">-foregroundcolor</font></span></i><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">Cyan</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot;Users created, view the log at $logPath&quot;</font></span></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: 12pt; list-style-type: disc; margin: 0cm 0cm 8pt" class="MsoNormal"><span style="line-height: 11pt; font-family: ; color: "><font size="1" face="Courier New">Exit</font></span></p>  <p>&#160;</p>  <p>- The third step is to create a Distribution Group containing these 2000 mailboxes (very easy as well using the Active Directory Users and Computers console)</p>  <p>- Then the last step is to use a quick Powershell script (a very simple script that wraps the Send-MailMessage default commendlet) to send one message to this DL, or simply to use an OWA connection to the “Administrator” mailbox or whichever mailbox you have on your Lab environment) </p>  <p>As an example, here is a script that <strong><a href="http://www.linkedin.com/in/jfrmilner">John Milner</a></strong> wrote and posted <a href="http://jfrmilner.wordpress.com/2010/08/26/send-mailmessages/">on one of his blog’s article</a> (thank you very much John ! – Just comment my article if you want me to remove your script from my blog page). </p>  <p>One handy feature of John’s script is that he use a parameter that allows to specify the size of the attachment, and create an attachment using the <strong>fsutil</strong> command within the script. Neat ! <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-smile" alt="Smile" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/1323.wlEmoticon-smile_2.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/1323.wlEmoticon_2D00_smile_5F00_2.png" /></p>  <p>&#160;</p>  <p><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1"># If not called, install the Exchange PSSnapin – Exchange 2007 only – use the “Import-Module” commandlet appropriately for Exchange 2010</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><b><span style="font-family: ; color: "><font color="#5f9ea0">Add-PSSnapin</font></span></b><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">Microsoft.Exchange.Management.PowerShell.Admin</font></span><span style="font-family: ; color: "> </span><i><span style="font-family: ; color: "><font color="#5f9ea0">-ErrorAction</font></span></i><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">SilentlyContinue</font></span></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font face="Courier New"><font size="1"><span style="font-family: ; color: "><font color="#0000ff">function</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#5f9ea0">Send-MailMessages</font></span><span style="font-family: ; color: "> {</span></font></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&lt;#</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">.SYNOPSIS</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Generate a constant flow of messages for diagnostic purposes.</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&#160;</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">.DESCRIPTION</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">This script is designed to assist in generating email messages for testing external message flow to and from your messaging infrastructure.</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">The ability to quickly send a batch of messages with an attachment on a schedule can help track flow issues or to simply be used to confirm mail routing.</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&#160;</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">.EXAMPLE</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Send-MailMessages -To Test@Test.com -From Admin@Contoso.com -MessageCount 10 -SecondsDelay 10 -AttachmentSizeKB 1</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Send 10 emails to Test@Test.com every 10 seconds with a 1MB Attachment</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&#160;</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">.EXAMPLE</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Send-MailMessages -MessageCount 48 -SecondsDelay 1800</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Send an email every 30 minutes for 24 hours.</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&#160;</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">.LINK</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">http://jfrmilner.wordpress.com/2010/08/26/send-mailmessages</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&#160;</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">.NOTES</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">File Name: Send-MailMessages.ps1</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&#160;</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Author: jfrmilner</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">&#160;</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Email: jfrmilner@googlemail.com</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Requires: Powershell V2</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Requires: Exchange Managemnent Shell (Only used to auto find the smtpServer)</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Legal: This script is provided &quot;AS IS&quot; with no warranties or guarantees, and confers no rights. You may use, modify, reproduce, and distribute this script file in any way provided that you agree to give the original author credit.</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Version: v1.0 - 2010 Aug 08 - First Version http://poshcode.org/*</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">Version: v1.1 - 2012 April 26 - Fixed when only a single HT Server is available. Added check for existing file. Fixed attachment parameter to use varible.</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font color="#008000" size="1">#&gt;</font></font></span><span style="font-family: ; color: "></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font face="Courier New"><font size="1"><span style="font-family: ; color: "><font color="#0000ff">param</font></span><span style="font-family: ; color: "> ( [Parameter(Mandatory</span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "><font color="#800080">$false</font></span><span style="font-family: ; color: ">)] </span><span style="font-family: ; color: "><font color="#800080">$To</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot;Test@WingtipToys.com&quot;</font></span><span style="font-family: ; color: ">, [Parameter(Mandatory</span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "><font color="#800080">$false</font></span><span style="font-family: ; color: ">)] </span><span style="font-family: ; color: "><font color="#800080">$From</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot;Postmaster@contoso.com&quot;</font></span><span style="font-family: ; color: ">, </span><span style="font-family: ; color: "><font color="#800080">$AttachmentSizeKB</font></span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "><font color="#800080">$null</font></span><span style="font-family: ; color: ">, </span><span style="font-family: ; color: "><font color="#800080">$MessageCount</font></span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: ">2, </span><span style="font-family: ; color: "><font color="#800080">$SecondsDelay</font></span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: ">10 )</span></font></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font face="Courier New"><font size="1"><span style="font-family: ; color: "><font color="#800080">$messageParameters</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> @{</span></font></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: "><span style="mso-spacerun: yes">&#160;</span>Body </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800080">$null</font></span><span style="font-family: ; color: "> | </span><b><span style="font-family: ; color: "><font color="#5f9ea0">ConvertTo-Html</font></span></b><span style="font-family: ; color: "> </span><i><span style="font-family: ; color: "><font color="#5f9ea0">-Body</font></span></i><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot;&lt;H2&gt; Test Message, Please ignore &lt;/H2&gt;&quot;</font></span><span style="font-family: ; color: "> | </span><b><span style="font-family: ; color: "><font color="#5f9ea0">Out-String</font></span></b></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: "><span style="mso-spacerun: yes">&#160;</span>From </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800080">$from</font></span></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font size="1"><font face="Courier New"><span style="font-family: ; color: "><span style="mso-spacerun: yes">&#160;</span>To </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800080">$to</font></span></font><span style="font-family: ; color: "></span></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font face="Courier New"><font size="1"><span style="font-family: ; color: "><span style="mso-spacerun: yes">&#160;</span>SmtpServer </span><span style="font-family: ; color: "><font color="#ff0000">=</font></span><span style="font-family: ; color: "> @(Get-TransportServer)[0].Name.ToString()</span></font></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font size="1"><span style="mso-spacerun: yes">&#160;</span>}</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font face="Courier New"><font size="1"><span style="font-family: ; color: "><font color="#0000ff">if</font></span><span style="font-family: ; color: "> (</span><span style="font-family: ; color: "><font color="#800080">$AttachmentSizeKB</font></span><span style="font-family: ; color: ">) {</span></font></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font face="Courier New"><font size="1"><span style="font-family: ; color: "><font color="#0000ff">if</font></span><span style="font-family: ; color: "> ((</span><b><span style="font-family: ; color: "><font color="#5f9ea0">Test-Path</font></span></b><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800080">$Env:TMP</font></span><span style="font-family: ; color: ">\$(</span><span style="font-family: ; color: "><font color="#800080">$AttachmentSizeKB</font></span><span style="font-family: ; color: ">)</span><span style="font-family: ; color: "><font color="#800000">mbfile.txt</font></span><span style="font-family: ; color: ">) </span><span style="font-family: ; color: "><font color="#ff0000">-ne</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800080">$true</font></span><span style="font-family: ; color: ">) </span></font></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font size="1"><span style="mso-tab-count: 1">&#160;&#160;&#160;&#160;&#160; </span>{</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font face="Courier New"><font size="1"><span style="font-family: ; color: "><span style="mso-spacerun: yes">&#160;</span><span style="mso-tab-count: 1">&#160;&#160;&#160;&#160; </span>fsutil file createnew </span><span style="font-family: ; color: "><font color="#800080">$Env:TMP</font></span><span style="font-family: ; color: ">\$(</span><span style="font-family: ; color: "><font color="#800080">$AttachmentSizeKB</font></span><span style="font-family: ; color: ">)mbfile.txt $(</span><span style="font-family: ; color: "><font color="#800080">$AttachmentSizeKB</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">*</font></span><span style="font-family: ; color: "> 1KB)</span></font></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font face="Courier New"><font size="1"><span style="mso-spacerun: yes">&#160;</span><span style="mso-tab-count: 1">&#160;&#160;&#160;&#160; </span>}</font></font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font face="Courier New"><font size="1"><span style="font-family: ; color: "><font color="#800080">$messageParameters</font></span><span style="font-family: ; color: ">.Add(</span><span style="font-family: ; color: "><font color="#800000">&quot;attachment&quot;</font></span><span style="font-family: ; color: ">, </span><span style="font-family: ; color: "><font color="#800000">&quot;$Env:TMP\$($AttachmentSizeKB)mbfile.txt&quot;</font></span><span style="font-family: ; color: ">) }</span></font></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><font face="Courier New"><font size="1"><span style="font-family: ; color: ">1..</span><span style="font-family: ; color: "><font color="#800080">$MessageCount</font></span><span style="font-family: ; color: "> | </span><b><span style="font-family: ; color: "><font color="#5f9ea0">%</font></span></b><span style="font-family: ; color: "> { </span><b><span style="font-family: ; color: "><font color="#5f9ea0">sleep</font></span></b><span style="font-family: ; color: "> </span><i><span style="font-family: ; color: "><font color="#5f9ea0">-Seconds</font></span></i><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800080">$secondsDelay</font></span><span style="font-family: ; color: "> ; </span><b><span style="font-family: ; color: "><font color="#5f9ea0">Send-MailMessage</font></span></b><span style="font-family: ; color: "> @messageParameters </span><i><span style="font-family: ; color: "><font color="#5f9ea0">-Subject</font></span></i><span style="font-family: ; color: "> (</span><span style="font-family: ; color: "><font color="#800000">&quot;Mailflow Test Email - &quot;</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">+</font></span><span style="font-family: ; color: "> (</span><b><span style="font-family: ; color: "><font color="#5f9ea0">Get-Date</font></span></b><span style="font-family: ; color: ">).ToLongTimeString() </span><span style="font-family: ; color: "><font color="#ff0000">+</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot; Message &quot;</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">+</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800080">$_</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#ff0000">+</font></span><span style="font-family: ; color: "> </span><span style="font-family: ; color: "><font color="#800000">&quot; / $MessageCount&quot;</font></span><span style="font-family: ; color: ">) </span><i><span style="font-family: ; color: "><font color="#5f9ea0">-BodyAsHtml</font></span></i><span style="font-family: ; color: "> }</span></font></font></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">}</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal"><span style="font-family: ; color: "><font size="1" face="Courier New">&#160;</font></span></p>  <p style="line-height: normal; list-style-type: disc; margin: 0cm 0cm 0pt; text-autospace: ; mso-layout-grid-align: none" class="MsoNormal">&#160;</p>  <p>Then execute John’s function :</p>  <p><font face="Courier New"><font size="1"><span style="font-family: ; color: "><font color="#5f9ea0">Send-MailMessages</font></span><span style="font-family: ; color: "> -To BugsRogers@domaina.contoso.ca -From Administrator@domaina.contoso.ca -MessageCount 1 -SecondsDelay 0 -AttachmentSizeKB 150</span></font></font></p>  <p>&#160;</p>  <p>The problem is :</p>  <ul>   <li>- A Distribution List with 2000 recipients won’t be deflated by a hub server if the recipients are on a mailbox serer on the same AD site as the HUB </li>    <li>- We have to either :      <ul>       <li>Put 2000 mailboxes in a DB, dismount that DB, send a message to these 2000 mailboxes </li>        <li>Or put 1 mailbox in a test DB, dismount that DB, send 2000 messages to that mailbox </li>        <li>Or create 2000 .EML files, and put all of these on the Pickup directory of the HUB server. </li>        <li>Or have a lab with 2 AD sites, with HUB/CAS/MBX server in that sites, and send a message to a DL with 2000 members from the other AD site. </li>     </ul>   </li> </ul>  <p>&#160;</p>  <p>Then what I tried that worked so far:</p>  <p>- Put one user in a temp DB (named “TempDB”)</p>  <p>- dismount TempDB</p>  <p>- Using the function brought by John Milner’s script above (I slightly modified his script a bit to change the “AttachmentSizeMB” parameter with “AttachmentSizeKB” to have smaller attachments), type :</p>  <p><font face="Courier New">Send-MailMessages -To </font><a href="mailto:Buck1.Rogers1@domaina.contoso.ca"><font face="Courier New">Buck1.Rogers1@domaina.contoso.ca</font></a><font face="Courier New"> -From </font><a href="mailto:Administrator@domaina.contoso.ca"><font face="Courier New">Administrator@domaina.contoso.ca</font></a><font face="Courier New"> -MessageCount 2000 -SecondsDelay 0 -AttachmentSizeKB 150</font></p>  <p>That works as the Perfmon testimonies it (Messages Queued for Delivery counter):</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/0005.image_6.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/0005.image_5F00_6.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/7041.image_thumb_2.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/7041.image_5F00_thumb_5F00_2.png" width="574" height="339" /></a></p>  <p>&#160;</p>  <p>&#160;</p>  <p>To be continued …</p>
