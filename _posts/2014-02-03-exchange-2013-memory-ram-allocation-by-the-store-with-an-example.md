---
layout: post
title: Exchange 2013 – Memory (RAM) allocation by the store with an example
date: 2014-02-03 20:09
author: sammykrosoft
comments: true
categories: [Uncategorized]
---
<p></p>  <p><strong><span style="text-decoration:underline;">First, a reminder of the theory:</span></strong></p>  <ul>   <li><strong>Exchange store is comprised of 3 services:</strong></li> </ul>  <ul>   <li>msexchangerepl.exe = Replication Service Process</li>    <li>Microsoft.Exchange.Store.Service.exe = Store Service Process (or Controller)</li>    <li>Microsoft.Exchange.Store.Worker.exe = Store Worker Process (1 per DB)</li> </ul>  <p></p>  <p><strong>•Algorithm will allocate total ESE cache available for all store worker processes based on physical RAM</strong></p>  <p>– ~25% of total memory allocated to ESE cache</p>  <p><strong>•ESE cache allocated to each database (store worker process) based on number of local database copies and MaximumActiveDatabases configuration</strong></p>  <p>– Static amount of ESE cache allocated to passive and active database copies</p>  <p><strong>•Passive database allocates 20% of max ESE cache target used for active database</strong></p>  <p>– Store worker process will only use max cache target when operating as active</p>  <p><strong>•Max cache target computed at service process startup</strong></p>  <p>– Restart service process when adding/removing copies or changing maximum active database configuration</p>  <p>&#160; </p>  <p><strong><span style="text-decoration:underline;">Example/illustration:</span></strong></p>  <p>1- Let’s say your server has <strong>64GB RAM</strong></p>  <p>2- Exchange 2013 store will calculate a max cache target</p>  <blockquote>   <p><strong>25% x 64GB RAM = 16GB</strong></p> </blockquote>  <p>That means that <strong><span style="text-decoration:underline;">potentially</span>, Exchange Store can allocate and use 16GB RAM maximum</strong>.</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/image_12.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/image_5F00_12.png"><img title="image" style="display:inline;" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/image_thumb_2.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/image_5F00_thumb_5F00_2.png" width="540" height="433" /></a></p>  <p>That would be if your server is hosting active databases only: as stated above, for passive databases, Exchange will allocate less memory.</p>  <p>See the point 3- below:</p>  <p></p>  <p>3- Say you will host <strong>10 databases on your server</strong>.</p>  <p>The Max cache target computed at service process startup (Microsoft.Exchange.Store.Service.exe) will be evenly distributed between each database : <strong>16GB / 10 = 1.6GB</strong>.</p>  <p>For databases that are <strong><span style="text-decoration:underline;">active</span></strong> on this server, Exchange Store will use <strong>1.6GB</strong> cache for these databases.</p>  <p>But for the <strong><span style="text-decoration:underline;">passive</span></strong> ones on this server, it will use only <strong>20% of the 1.6GB </strong>that the Store service that is <strong>327.68MB</strong></p>  <p><a href="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/image_6.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/image_5F00_6.png"><img title="image" style="display:inline;" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/5355.image_thumb_1.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/5355.image_5F00_thumb_5F00_1.png" width="593" height="475" /></a></p>  <p></p>  <p></p>  <p>So for 5 Passive databases and 5 Active databases, the RAM usage for the Store processes will be</p>  <p>( Max allocated cache per DB x nb active DBs ) + 20% x (Max allocated cache per DB x nb of passive DBs)</p>  <p><strong>( 1.6 x 5 ) + 20% x ( 1.6 x 5 ) = 9.6GB</strong></p>  <p></p>  <p>If you activate all 10 databases on this server, then the RAM usage will then just be :</p>  <p><strong>1.6 x 10 = 16GB.</strong></p>  <p>&#160;</p>  <p><a href="https://gallery.technet.microsoft.com/Exchange-2013-Dynamic-b49e5e69"><font size="4">Download the tool that produces the nice graphs and examples above !</font></a></p>  <p><a href="https://gallery.technet.microsoft.com/Exchange-2013-Dynamic-b49e5e69"><img title="image" style="display:inline;" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/TNBlogsFS/prod.evol.blogs.technet.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/00/73/61/metablogapi/image_7.png" original-url="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-73-61-metablogapi/image_5F00_7.png" width="374" height="222" /></a> </p>  <div id="scid:8eb9d37f-1541-4f29-b6f4-1eea890d4876:1f63a44a-ff63-478a-8cf3-4763126aa704" class="wlWriterEditableSmartContent" style="margin:0px;padding:0px;float:none;display:inline;"><div id="scid:8eb9d37f-1541-4f29-b6f4-1eea890d4876:1f63a44a-ff63-478a-8cf3-4763126aa704" class="wlWriterSmartContent" style="margin:0px;padding:0px;float:none;display:inline;"></div></div>
