---
layout: post
title: Exchange Server 2010 SP1 and above â€“ Error putting 2 servers at a time in maintenance mode using StartDagMaintenance.ps1 script
date: 2013-10-07 11:27
author: sammykrosoft
comments: true
categories: [Uncategorized]
---
<p>&nbsp;<p>&nbsp;</p><p>&nbsp;</p><p class="MsoNormal">The <i>StartDagMaintenance.ps1</i> script pauses servers cluster node and blocks chosen servers and databases from being mounted. Here is what it does in the below example, for en environment that has 3 or more Servers with 3 or more database copies per database: </p><p></p><p></p><p class="MsoNormal"></p><p>&nbsp;</p><p></p><p class="MsoNormal">Here is the logic used by the script (big thanks to <strong>Allan Wang &ndash; US PFE </strong>for putting the below together !):</p><ul>   <li>     <div class="MsoNormal">SERVER_1 (who is already in maintenance) was chosen because </div>   </li> </ul><p class="MsoNormal">&nbsp;</p><ul>   <ul>     <li>       <div class="MsoNormal">1/ the activation preference is set to &ldquo;1&rdquo;, </div>     </li>   </ul> </ul><blockquote>   <p class="MsoNormal">AND </p> </blockquote><ul>   <ul>     <li>       <div class="MsoNormal">2/ it has the following conditions: &ldquo;<span style='font-family: "Courier New";'>Status=Healthy, ContentIndexing=Healthy, CopyQueueLength=0, ReplayQueueLength=0</span>&rdquo;</div>     </li>   </ul> </ul><p class="MsoNormal"><span style="color: rgb(31, 73, 125);"></span></p><p>&nbsp;</p><p></p><p class="MsoNormal"><i><span style="background: yellow; color: rgb(31, 73, 125); mso-highlight: yellow;">VERBOSE: [01:45:10.133 UTC] Move-DagMasterCopy: Entering: `$db=DB10, `$srcServer=SERVER_2, `$preferredTarget=</span><span style="color: rgb(31, 73, 125);"> </span></i></p><p></p><i></i><p></p><p class="MsoNormal"><i><span style="background: yellow; color: rgb(31, 73, 125); mso-highlight: yellow;">VERBOSE: [01:45:10.180 UTC] Test-DagTargetCopy: Testing move criteria for DB10SERVER_1, with `$Lossless=True and </span></i></p><p></p><i></i><p></p><p class="MsoNormal"><i><span style="background: yellow; color: rgb(31, 73, 125); mso-highlight: yellow;">`$CICheck=False ...</span><span style="color: rgb(31, 73, 125);"> </span></i></p><p></p><i></i><p></p><p class="MsoNormal"><i><span style="background: yellow; color: rgb(31, 73, 125); mso-highlight: yellow;">VERBOSE: [01:45:10.196 UTC] Test-DagTargetCopy: Name='RED02RED-MLT-1', Status='</span><span style="background: lime; color: rgb(31, 73, 125); mso-highlight: lime;">Healthy</span><span style="background: yellow; color: rgb(31, 73, 125); mso-highlight: yellow;">', CIStatus='</span><span style="background: lime; color: rgb(31, 73, 125); mso-highlight: lime;">Healthy'</span><span style="background: yellow; color: rgb(31, 73, 125); mso-highlight: yellow;">, </span></i></p><p></p><i></i><p></p><p class="MsoNormal"><i><span style="background: yellow; color: rgb(31, 73, 125); mso-highlight: yellow;">CopyQueueLength=</span><span style="background: lime; color: rgb(31, 73, 125); mso-highlight: lime;">0</span><span style="background: yellow; color: rgb(31, 73, 125); mso-highlight: yellow;">, ReplayQueueLength=</span><span style="background: lime; color: rgb(31, 73, 125); mso-highlight: lime;">0</span><span style="color: rgb(31, 73, 125);"> </span></i></p><p></p><i></i><p></p><p class="MsoNormal"><i><span style="background: lime; color: rgb(31, 73, 125); mso-highlight: lime;">VERBOSE: [01:45:10.196 UTC] Test-DagTargetCopy: Leaving (returning 'True')</span><span style="color: rgb(31, 73, 125);"> </span></i></p><p></p><i></i><p></p><p class="MsoNormal"></p><p>&nbsp;</p><p></p><p class="MsoNormal">The suggestion made to administrators is to suspend the database after the server is put into maintenance so that the logic would most likely skip it (Overall status will change to &ldquo;<i>Suspended</i>&rdquo; then the script won&rsquo;t try to mount databases on it) </p><p>&nbsp;</p><p>*********** Below example put together by <strong>Bernard Chouinard, Canadian independant Consultant</strong> *********</p><p>&nbsp;</p><ul>   <li>Start the Dag maintenance on the first server with the dag maintenance script (<font face="Courier New">StartDagMaintenance.ps1 &ndash;ServerName &lt;First_Server_Name&gt;</font>)</li> </ul><p>&nbsp;</p><ul>   <li>Then suspend databases on this same first server with the below script:</li> </ul><p><font face="Courier New">#Get database on the first server</font></p><p><font face="Courier New">$dbases = Get-MailboxDatabaseCopyStatus -Server servername</font></p><p><font face="Courier New">#Suspend the database copy, this is so when the second server is put into maintenance mode it does not select the first server to move databases to</font></p><p><font face="Courier New">$dbases | %{if ((Get-MailboxDatabase $($_.DatabaseName)).ReplicationType -eq 'Remote'){Suspend-MailboxDatabaseCopy $($_.Name) -SuspendComment 'Serverbeing patched and rebooted' -Confirm:$false}}</font></p><p>&nbsp;</p><ul>   <li>Start the Dag maintenance on the second server with the dag maintenance script (<font face="Courier New">StartDagMaintenance.ps1 &ndash;ServerName &lt;SECOND_Server_Name&gt;</font>) &ndash; NOTE: databases will be on a third server, but the script won&rsquo;t try to mount databases on the FIRST server as it&rsquo;s suspended now.</li> </ul><p>&nbsp;</p><ul>   <li>Then resume (&ldquo;un-suspend&rdquo;) databases on the first server &ndash; NOTE: they will continue to replicate, but still be blocked from activation as we ran StartDagMaintenance.ps1 earlier&hellip;</li> </ul><p><font face="Courier New">#Resume the database copy on the first server</font></p><p><font face="Courier New">$dbases | %{if ((Get-MailboxDatabase $($_.DatabaseName)).ReplicationType -eq 'Remote'){Resume-MailboxDatabaseCopy $($_.Name) -Confirm:$false}}</font></p><p>&nbsp;</p><p>****************** Example end &ndash; Thank you very much Bernard ! *****************</p><p class="MsoNormal"></p><p>&nbsp;</p><p></p><p class="MsoNormal">Or, if you are a scripting warrior, you can add an &ldquo;IF&rdquo; statement to test the <span style='font-family: "Courier New";'>DatabaseCopyAutoActivationPolicy</span>&nbsp; parameter and/or the database status (as the StartDagMaintenance.ps1 script also set individual databases as suspended for activation only).</p><p class="MsoNormal">&nbsp;</p><p class="MsoNormal"></p><p>Sam.</p></p>

