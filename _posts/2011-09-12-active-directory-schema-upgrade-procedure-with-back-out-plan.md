---
layout: post
title: Active Directory Schema upgrade procedure - with back-out plan
date: 2011-09-12 18:46
author: sammykrosoft
comments: true
categories: [Uncategorized]
---
<p>&nbsp;<p>The aim of the procedure in this post is to avoid you to dig around the technet to rebuild it. It&rsquo;s written for Exchange 2010 SP1 here, but can easily be adapted for any product schema updates by replacing the Exchange 2010 SP1 values and links !</p><p>&nbsp;</p><h1>AD Schema upgrade procedure with verifications (can be adapted as a general procedure by changing the Exchange 2010 SP1 references and values)</h1><p>Perform Exchange server 2010 SP1 schema extension, the full procedure list is available online at <a href="http://technet.microsoft.com/en-us/library/bb125224.aspx">http://technet.microsoft.com/en-us/library/bb125224.aspx</a> :</p><p>1. Confirmation that the &ldquo;<strong>Back-Out Plan</strong>&rdquo; (see below) has been prepared.</p><p>2. Logon to the Domain Controller holding the <strong>Schema Master</strong> FSMO role using a credential that belongs to the <strong>Schema Admins</strong> security group and <strong>Enterprise Admins</strong> security group.</p><p>3. Dump the current schema into a file for comparison.&nbsp; From a command prompt, run the command:&nbsp; <strong>Ldifde -f Before_Schema_Update.ldf -d "cn=schema,cn=configuration,dc=domain,dc=root"</strong></p><p>&nbsp;</p><p><span style="text-decoration: underline;"><strong>Important note : although the following step technically works, blocking AD replication by any means is not recommended, and not supported by Microsoft</strong></span>. As my colleague and AD expert Tanner Slayton comments (taking his words as these are complete and meaningful), Microsoft Best Practices are to <strong>test the upgrade in a Lab, ensure that a tested and well-documented Disaster Recovery plan is in place</strong> (e.g. including a detailed&nbsp;authoritative restore procedure of the AD to recover a previous good AD state in an unlikely case of corruption during the schema update), validate the schema extensions using <span style="text-decoration: underline;"><strong>Step 6.</strong></span> below for example, and ensure all DC's are healthy and replicating properly.</p><p>&nbsp;</p><p>&nbsp;</p><p><em>&lt;***update**** Unsupported and not recommended... test in a lab, document DR plan, rely on&nbsp;this DR plan&nbsp;in case of schema update issue **********&gt;</em></p><p><em>4. Ensure no replication from this Domain Controller is going to replicate to other server until Schema Extension is completed and verified:</em></p><p><em>a. Disable Outbound Replication on the server</em></p><blockquote>
<p><em>i. At a command prompt, run the command: &ldquo;<strong>repadmin /options +DISABLE_OUTBOUND_REPL</strong>&rdquo; without the quotation marks.</em></p>
<p><em>ii. Unplug the physical network connection to ensure no communication could occur with other domain controllers.</em></p>
</blockquote><p><em>&lt;***update**** Apart from the above "+disable_outbound_repl" steps and the below "-disable_outbound_repl" on Step 8., the remainder of the article remains well supported **********&gt;</em></p><p>&nbsp;</p><p>&nbsp;</p><p>5. At a command prompt, run the command &ldquo;<strong>setup /PrepareSchema</strong>&rdquo; from the folder where the Exchange 2007 SP3 installation files are located.</p><p>6. If there is no error during the schema extension, then verify the current schema version.&nbsp;</p><blockquote>
<p>a. Open ADSIEdit and check the Schema version located in:</p>
<p><strong>&nbsp;&nbsp; CN=ms-Exch-Schema-Version-Pt,CN=Schema,CN=Configuration,DC &lt;root domain&gt;</strong><strong></strong></p>
<p><strong>&nbsp;&nbsp; Attribute: rangeUpper</strong></p>
<p>&nbsp;&nbsp; For Exchange server 2010 SP1, the value should be &ldquo;<strong>14726</strong>&rdquo;</p>
</blockquote><blockquote>
<p>b. In the same ADSIEdit session, check the <strong>ObjectVersion</strong> location in:<strong></strong></p>
<p><strong>&nbsp;&nbsp; CN=&lt;your organization&gt;, CN=Microsoft Exchange,CN=Services,CN=Configuration,DC=&lt;domain</strong></p>
<p><strong>&nbsp;&nbsp; Attribute: ObjectVersion</strong></p>
<p>&nbsp;&nbsp; For Exchange server 2010 SP1, the value should be &ldquo;<strong>13214</strong>&rdquo;</p>
</blockquote><blockquote>
<p>c. Dump the current schema into a file and compare with the one obtained in step 3.&nbsp; From a command prompt, run the command:&nbsp; <strong>Ldifde -f After_Schema_Update.ldf -d "cn=schema,cn=configuration,dc=domain,dc=root"</strong></p>
</blockquote><blockquote>
<p>d. Compare the content in the file <strong>Before_Schema_Update.ldf</strong> and <strong>After_Schema_Update.ldf</strong> to ensure proper extension is completed.&nbsp; For a list of schema changes applied by Exchange server 2010 SP1 is available online at <a href="http://msdn.microsoft.com/en-us/library/dd877014(EXCHG.140).aspx">http://msdn.microsoft.com/en-us/library/dd877014(EXCHG.140).aspx</a> <strong></strong></p>
</blockquote><p>7. If the schema extension is unsuccessful or error was encountered during the extension, perform back out procedure for Schema Extension.</p><p>&nbsp;</p><p><em>&lt;***update**** Unsupported and not recommended... test in a lab, document DR plan, rely on&nbsp;this DR plan&nbsp;in case of schema update issue **********&gt;</em></p><p><em>8. If schema extension is successful and verified</em></p><blockquote>
<p><em>a. re-enable Outbound Replication on the server</em></p>
</blockquote><blockquote>
<p><em>&nbsp;&nbsp;&nbsp; i. At a command prompt, run the command: &ldquo;<strong>repadmin /options -DISABLE_OUTBOUND_REPL</strong>&rdquo; without the quotation marks.</em></p>
<p><em>&nbsp;&nbsp;&nbsp; ii. Re-connect the network cable</em></p>
</blockquote><p><em>&lt;***update******* Apart from the "+disable_outbound_repl" steps on Step 4. and the&nbsp;above "-disable_outbound_repl" on Step 8., the remainder of the article remains well supported **********&gt;</em></p><p>&nbsp;</p><p>9. Force replication of Active Directory</p><p>10. Allow time for replication to be completed before execution of this step.&nbsp; At a command prompt, run the command &ldquo;<strong>setup /PrepareAD</strong>&rdquo; from the folder where the Exchange 2010 SP1 installation files are located.</p><p>11. For every domain that you have Exchange servers deployed and users having Exchange mailboxes, run the command &ldquo;<strong>setup /PrepareDomain&rdquo;</strong>.</p><h4>&nbsp;</h4><h1>&nbsp;</h1><p><span style="background-color: #ffff00;"><strong><span style="text-decoration: underline;">***Update</span>: The below back-out procedure takes into account the steps used to disable replication above, which are not supported and not recommended by Microsoft any more.</strong></span></p><p><span style="text-decoration: underline;"><span style="background-color: #ffff00;"><strong>Instead, the recommended Back-Out plan procedure&nbsp;is to have a well-documented and tested DR procedure including an authoritative restore procedure in case of AD corruption.</strong></span></span></p><h1><a name="_Toc287015684"></a>Back-out plan Procedure (never had to use it but it&rsquo;s a parachute/belt/mattress to sleep well)</h1><p>In case of incomplete schema extension or getting error during the schema extension, to avoid for any partial update of the schema to be replicated to other Domain Controllers, we must follow the steps below:</p><p>1. Power off the current Domain Controller that we&rsquo;re working with, i.e. the current Schema master.</p><p>2. Go to another Domain Controller in the same domain, and seize the <strong>Schema Master</strong> FSMO role:</p><blockquote>
<p>a. Logon to the Domain Controller using a credential that has <strong>Enterprise Administrator</strong> privilege</p>
<p>b. Click <strong>Start</strong>, click <strong>Run</strong>, type <strong>ntdsutil</strong> in the Open box, and then click <strong>OK</strong>.</p>
<p>c. Type <strong>roles</strong>, and then press <strong>ENTER</strong>.</p>
<p>d. Type <strong>connections</strong>, and then press <strong>ENTER</strong>.</p>
<p>e. Type <strong>connect to server &lt;servername&gt;</strong>, and then press <strong>ENTER</strong>, where &lt;servername&gt; is the name of the domain controller that you want to assign the FSMO role to.</p>
<p>f. At the server connections prompt, type <strong>q</strong>, and then press <strong>ENTER</strong>.</p>
<p>g. Type <strong>seize Schema Master</strong>.</p>
<p>h. At the fsmo maintenance prompt, type <strong>q</strong>, and then press <strong>ENTER</strong> to gain access to the ntdsutil prompt. Type <strong>q</strong>, and then press <strong>ENTER</strong> to quit the Ntdsutil utility.</p>
</blockquote><p>3. Perform meta data clean up to remove the domain controller we use for Schema Extension, this is to ensure non partial schema extension get replicated:</p><blockquote>
<p>a. Stay logon to the same server with the same credential as in step 2</p>
<p>b. Click <strong>Start</strong>, click <strong>Run</strong>, type <strong>ntdsutil</strong> in the Open box, and then click <strong>OK</strong>.</p>
<p>c. Type <strong>metadata cleanup</strong>, and then press <strong>ENTER</strong>.</p>
<p>d. At the metadata cleanup prompt, type <strong>remove selected server &lt;ServerName&gt; </strong>where &lt;ServerName&gt; is the distinguished name of the domain controller whose metadata you want to remove, in the form of <strong>cn=ServerName,cn=Servers,cn=SiteName,cn=Sites,cn=Configuration,dc=ForestRootDomain</strong></p>
<p>e. To verify that the server was removed, type <strong>list servers in site</strong>, and then press <strong>ENTER</strong>. Ensure that the domain controller that you wanted to be removed is no longer displayed in the command output.</p>
<p>f. At the <strong>metadata cleanup:</strong> and <strong>ntdsutil:</strong> prompts, type <strong>quit</strong>.</p>
</blockquote><p><strong>Important:&nbsp; </strong>If the domain controller that was removed was also a DNS server, ensure that references to it are removed from the Name Servers tab in the DNS console. To do this, open the DNS console using another DNS server in the domain (dnsmgmt.msc), and then click the domain name under Forward Lookup Zones. Remove any references to the domain controller that was removed from the domain.</p><p>4. Clean up all DNS record related to the old Schema Master server</p><p>5. Format the old Schema Master machine, reinstall Operating System, Reset computer account for the old server name, join back into the domain and prompt to Domain Controller and Global Catalog if that was its old configuration.</p><p>Full documentation of how to clean up the Active Directory after an unsuccessful demotion of Domain Controllers, which is similar to the situation we have here, is available online at <a href="http://support.microsoft.com/kb/216498">http://support.microsoft.com/kb/216498</a>.</p></p>

